name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # macOS Tests
  test-macos:
    name: Test on macOS
    runs-on: macos-14
    strategy:
      matrix:
        # Test on multiple Xcode versions for better compatibility coverage
        xcode: ['15.2', '15.4']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode }}.app/Contents/Developer

    - name: Show Swift version
      run: swift --version

    - name: Build package
      run: swift build -v

    - name: Run tests with coverage
      run: swift test --enable-code-coverage

    - name: Generate coverage report
      if: matrix.xcode == '15.4'  # Only generate coverage for one Xcode version to avoid duplicates
      run: |
        set -euo pipefail
        TEST_BIN=$(ls .build/*/debug/SwiftDICOMDecoderPackageTests.xctest/Contents/MacOS/SwiftDICOMDecoderPackageTests | head -n1)
        PROFDATA=$(ls .build/*/debug/codecov/default.profdata | head -n1)
        xcrun llvm-cov export -format="lcov" "$TEST_BIN" \
          -instr-profile "$PROFDATA" > coverage.lcov

    - name: Upload coverage to Codecov
      if: matrix.xcode == '15.4'
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.lcov
        flags: macos
        name: macOS-coverage
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # iOS Simulator Tests
  test-ios:
    name: Test on iOS Simulator
    runs-on: macos-14
    strategy:
      matrix:
        # Test on multiple iOS versions for better compatibility coverage
        destination:
          - 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2'
          - 'platform=iOS Simulator,name=iPhone 15,OS=17.4'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

    - name: Resolve Xcode scheme
      id: resolve_scheme
      run: |
        set -euo pipefail
        SCHEMES=$(xcrun xcodebuild -list -json 2>&1 | python3 - <<'PY'
        import json, sys
        text = sys.stdin.read()
        start = text.find('{')
        end = text.rfind('}')
        if start == -1 or end == -1:
            sys.stderr.write("xcodebuild -list -json did not return JSON. Output:\n")
            sys.stderr.write(text + "\n")
            raise SystemExit(1)
        data = json.loads(text[start:end + 1])
        workspace = data.get("workspace") or {}
        project = data.get("project") or {}
        schemes = workspace.get("schemes") or project.get("schemes") or []
        print("\n".join(schemes))
        PY
        )
        echo "Available schemes:"
        echo "$SCHEMES"
        for candidate in "DicomCore-Package" "DicomCore" "SwiftDICOMDecoder" "SwiftDICOMDecoder-Package"; do
          if echo "$SCHEMES" | grep -Fxq "$candidate"; then
            echo "scheme=$candidate" >> "$GITHUB_OUTPUT"
            echo "Using scheme: $candidate"
            exit 0
          fi
        done
        SCHEME=$(echo "$SCHEMES" | head -n1)
        if [ -z "$SCHEME" ]; then
          echo "No Xcode schemes found." >&2
          exit 1
        fi
        echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"
        echo "Using fallback scheme: $SCHEME"

    - name: Show available simulators
      run: xcrun xcodebuild -showdestinations -scheme "${{ steps.resolve_scheme.outputs.scheme }}"

    - name: Build for iOS
      run: |
        xcodebuild build-for-testing \
          -scheme "${{ steps.resolve_scheme.outputs.scheme }}" \
          -destination "${{ matrix.destination }}" \
          -enableCodeCoverage YES \
          -derivedDataPath .build/ios

    - name: Run iOS tests
      run: |
        xcodebuild test-without-building \
          -scheme "${{ steps.resolve_scheme.outputs.scheme }}" \
          -destination "${{ matrix.destination }}" \
          -enableCodeCoverage YES \
          -derivedDataPath .build/ios

    - name: Generate iOS coverage report
      if: contains(matrix.destination, 'iPhone 15 Pro')  # Only generate coverage for one destination
      run: |
        xcrun xccov view --report --json .build/ios/Logs/Test/*.xcresult > coverage-ios.json || true

    - name: Upload iOS coverage to Codecov
      if: contains(matrix.destination, 'iPhone 15 Pro')
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage-ios.json
        flags: ios
        name: iOS-coverage
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # Code Quality Checks
  quality:
    name: Code Quality
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

    - name: Check Swift format (if SwiftFormat config exists)
      run: |
        if [ -f .swiftformat ]; then
          brew install swiftformat
          swiftformat --lint .
        else
          echo "No SwiftFormat configuration found, skipping"
        fi
      continue-on-error: true

    - name: Check for TODO/FIXME comments
      run: |
        echo "Scanning for TODO/FIXME comments..."
        find Sources Tests -name "*.swift" -exec grep -Hn "TODO\|FIXME" {} \; || echo "No TODO/FIXME found"
      continue-on-error: true

    - name: Verify no debug print statements
      run: |
        echo "Checking for debug print statements..."
        ! grep -r "print(" Sources/ || (echo "Found print statements in production code" && exit 1)

  # Summary Job
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-macos, test-ios, quality]
    if: always()

    steps:
    - name: Check test results
      run: |
        if [ "${{ needs.test-macos.result }}" != "success" ] || \
           [ "${{ needs.test-ios.result }}" != "success" ]; then
          echo "âŒ Tests failed"
          exit 1
        else
          echo "âœ… All tests passed"
        fi

    - name: Post summary
      run: |
        echo "## Test Results ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- macOS Tests: ${{ needs.test-macos.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- iOS Tests: ${{ needs.test-ios.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Code Quality: ${{ needs.quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Coverage reports uploaded to Codecov" >> $GITHUB_STEP_SUMMARY
